<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador Financeiro Anual</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --primary-color: #2c2c2c;
            --secondary-color: #444;
            --text-color: #e0e0e0;
            --accent-color: #00aaff;
            --danger-color: #ff4d4d;
            --success-color: #4dff4d;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; }
        .main-container { width: 100%; max-width: 1000px; background-color: var(--primary-color); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); position: relative; }
        #logout-btn { position: absolute; top: 20px; right: 25px; background-color: var(--danger-color); color: white; border: none; padding: 8px 16px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: opacity 0.3s; z-index: 10; }
        #logout-btn:hover { opacity: 0.8; }
        
        /* --- Estilos das Abas --- */
        .tab-bar { display: flex; border-bottom: 2px solid var(--secondary-color); margin-bottom: 20px; align-items: center; }
        .tab { padding: 12px 18px; cursor: pointer; background-color: transparent; border: none; color: var(--text-color); font-size: 1em; border-bottom: 3px solid transparent; }
        .tab.active { color: var(--accent-color); border-bottom: 3px solid var(--accent-color); font-weight: bold; }
        .tab:hover { background-color: var(--secondary-color); }
        #add-tab-btn { background-color: var(--accent-color); color: var(--bg-color); border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px; font-weight: bold; cursor: pointer; margin-left: 10px; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        h1, h2, h3 { text-align: center; color: var(--accent-color); }
        .planner { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; }
        .card { background-color: var(--secondary-color); padding: 20px; border-radius: var(--border-radius); }
        .card h3 { margin-top: 0; color: var(--text-color); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--primary-color); }
        .data-table th { background-color: var(--accent-color); color: var(--bg-color); }
        .data-table input { width: 95%; padding: 10px; box-sizing: border-box; background-color: var(--primary-color); border: 1px solid var(--secondary-color); color: var(--text-color); border-radius: 5px; font-size: 1em; }
        .data-table .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .add-row-btn { display: block; width: 100%; padding: 12px; margin-top: 15px; background-color: var(--accent-color); color: var(--bg-color); border: none; border-radius: 5px; font-size: 1em; font-weight: bold; cursor: pointer; }
        .summary { background-color: var(--primary-color); margin-top: 30px; padding: 20px; border-radius: var(--border-radius); text-align: center; border: 2px solid var(--secondary-color); }
        .summary-item { margin: 15px 0; font-size: 1.2em; }
        .summary-item span { font-weight: bold; padding: 5px 10px; border-radius: 5px; }
        #total-income { color: var(--success-color); }
        #total-expenses { color: var(--danger-color); }
        #final-balance { font-size: 1.5em; }
        .charts-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .chart-container { padding: 20px; background-color: var(--secondary-color); border-radius: var(--border-radius); }
        .chart-container h2 { border: none; color: var(--text-color); font-size: 1.2em; }
        #annual-summary-chart-container { width: 100%; max-width: 800px; margin: 20px auto; }
        .actions-card { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .action-btn { padding: 10px 20px; background-color: var(--accent-color); color: var(--bg-color); border: none; border-radius: 5px; font-size: 1em; font-weight: bold; cursor: pointer; }
        input[type="file"] { display: none; }
        @media (max-width: 768px) { .charts-wrapper { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="main-container">
        <button id="logout-btn">Sair</button>
        <h1>Planejador Financeiro</h1>

        <div class="tab-bar" id="tab-bar">
            </div>

        <div class="actions-card">
            <button id="save-btn" class="action-btn">Salvar Dados</button>
            <label for="file-input" class="action-btn">Carregar Dados</label>
            <input type="file" id="file-input" accept=".txt">
        </div>

        <div id="tab-content-container">
            </div>
    </div>

    <template id="month-tab-template">
        <div class="planner-wrapper">
            <div class="planner">
                <div class="card">
                    <h3>Receita Mensal</h3>
                    <table class="data-table income-table">
                        <thead><tr><th>Descrição</th><th>Valor (R$)</th><th>Ação</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button class="add-row-btn add-income-btn">Adicionar Receita</button>
                </div>
                <div class="card">
                    <h3>Despesas</h3>
                    <table class="data-table expense-table">
                        <thead><tr><th>Descrição</th><th>Valor (R$)</th><th>Ação</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button class="add-row-btn add-expense-btn">Adicionar Despesa</button>
                </div>
            </div>
            <div class="summary">
                <h2>Resumo Financeiro do Mês</h2>
                <div class="summary-item">Total de Receitas: <span class="total-income">R$ 0,00</span></div>
                <div class="summary-item">Total de Despesas: <span class="total-expenses">R$ 0,00</span></div>
                <hr style="border-color: var(--secondary-color);">
                <div class="summary-item"><strong>Saldo Final:</strong> <span class="final-balance">R$ 0,00</span></div>
            </div>
            <div class="charts-wrapper">
                <div class="chart-container">
                    <h2>Detalhamento das Receitas</h2>
                    <canvas class="income-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h2>Detalhamento das Despesas</h2>
                    <canvas class="expense-chart"></canvas>
                </div>
            </div>
        </div>
    </template>

<script>
// --- VARIÁVEIS GLOBAIS E ESTADO DA APLICAÇÃO ---
let appData = {}; // Objeto principal que guarda os dados de todos os meses
let activeTabId = null; // Guarda o ID da aba ativa (ex: 'summary' ou '2025-09')
const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
const DATA_STORAGE_KEY = 'financialPlannerData';

// --- ELEMENTOS DO DOM ---
const tabBar = document.getElementById('tab-bar');
const tabContentContainer = document.getElementById('tab-content-container');
const monthTabTemplate = document.getElementById('month-tab-template');
const logoutBtn = document.getElementById('logout-btn');
const saveBtn = document.getElementById('save-btn');
const fileInput = document.getElementById('file-input');

// --- INICIALIZAÇÃO ---
document.addEventListener('DOMContentLoaded', initialize);

function initialize() {
    loadAppData();
    renderTabs();
    if (Object.keys(appData).length === 0) {
        const today = new Date();
        const currentMonthId = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        addMonth(currentMonthId);
    } else {
        switchTab('summary');
    }
    
    logoutBtn.addEventListener('click', () => {
        alert("Você está sendo desconectado.");
        window.location.href = 'index.html';
    });
    
    saveBtn.addEventListener('click', saveDataToFile);
    fileInput.addEventListener('change', loadDataFromFile);
}

// --- GERENCIAMENTO DE ABAS E RENDERIZAÇÃO ---

function renderTabs() {
    tabBar.innerHTML = ''; // Limpa as abas existentes

    // Adiciona a aba de Resumo Anual
    const summaryTab = createTab('summary', 'Resumo Anual');
    tabBar.appendChild(summaryTab);

    // Adiciona abas para cada mês nos dados, ordenadas
    const monthIds = Object.keys(appData).sort();
    monthIds.forEach(monthId => {
        const [year, month] = monthId.split('-');
        const tabName = `${monthNames[parseInt(month) - 1]} ${year}`;
        const monthTab = createTab(monthId, tabName);
        tabBar.appendChild(monthTab);
    });

    // Adiciona o botão de "+"
    const addBtn = document.createElement('button');
    addBtn.id = 'add-tab-btn';
    addBtn.textContent = '+';
    addBtn.title = 'Adicionar novo mês';
    addBtn.onclick = handleAddMonth;
    tabBar.appendChild(addBtn);

    // Reativa a aba que estava ativa
    const activeTabElement = tabBar.querySelector(`.tab[data-tab-id="${activeTabId}"]`);
    if (activeTabElement) {
        activeTabElement.classList.add('active');
    }
}

function createTab(id, name) {
    const tab = document.createElement('button');
    tab.className = 'tab';
    tab.dataset.tabId = id;
    tab.textContent = name;
    tab.onclick = () => switchTab(id);
    return tab;
}

function switchTab(tabId) {
    if (activeTabId && activeTabId !== 'summary') {
        saveCurrentTabData();
    }
    
    activeTabId = tabId;
    
    // Atualiza a classe 'active' nas abas
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab-id="${tabId}"]`).classList.add('active');

    // Mostra o conteúdo correto
    tabContentContainer.innerHTML = '';
    if (tabId === 'summary') {
        renderSummaryView();
    } else {
        renderMonthView(tabId);
    }
}

function renderMonthView(monthId) {
    const content = monthTabTemplate.content.cloneNode(true);
    tabContentContainer.appendChild(content);

    const monthData = appData[monthId];
    const view = tabContentContainer;

    // Popula as tabelas
    const incomeTbody = view.querySelector('.income-table tbody');
    const expenseTbody = view.querySelector('.expense-table tbody');
    (monthData.incomes || []).forEach(item => addRowToTable(incomeTbody, item.description, item.value));
    (monthData.expenses || []).forEach(item => addRowToTable(expenseTbody, item.description, item.value));

    // Adiciona listeners aos botões
    view.querySelector('.add-income-btn').onclick = () => addRowToTable(incomeTbody);
    view.querySelector('.add-expense-btn').onclick = () => addRowToTable(expenseTbody);

    // Inicializa os gráficos de pizza
    const incomeChartCanvas = view.querySelector('.income-chart');
    const expenseChartCanvas = view.querySelector('.expense-chart');
    monthData.incomeChart = createDoughnutChart(incomeChartCanvas);
    monthData.expenseChart = createDoughnutChart(expenseChartCanvas);

    updateMonthView(monthId);
}

function renderSummaryView() {
    const summaryContainer = document.createElement('div');
    summaryContainer.id = 'annual-summary-chart-container';
    summaryContainer.innerHTML = `<h2>Evolução Financeira Anual</h2><canvas id="annual-line-chart"></canvas>`;
    tabContentContainer.appendChild(summaryContainer);

    const labels = [];
    const incomeData = [];
    const expenseData = [];
    
    const monthIds = Object.keys(appData).sort();
    monthIds.forEach(monthId => {
        const [year, month] = monthId.split('-');
        labels.push(`${monthNames[parseInt(month)-1].substring(0,3)}/${year.substring(2,4)}`);
        
        const monthTotals = calculateMonthTotals(appData[monthId]);
        incomeData.push(monthTotals.totalIncome);
        expenseData.push(monthTotals.totalExpenses);
    });

    createLineChart(document.getElementById('annual-line-chart'), labels, incomeData, expenseData);
}


// --- LÓGICA DE MANIPULAÇÃO DE DADOS E UI DO MÊS ---

function addRowToTable(tbody, description = '', value = '') {
    const row = tbody.insertRow();
    row.innerHTML = `
        <td><input type="text" class="description-input" placeholder="Descrição" value="${description}"></td>
        <td><input type="number" class="value-input" placeholder="0.00" value="${value}"></td>
        <td><button class="delete-btn">X</button></td>
    `;
    row.querySelector('.delete-btn').onclick = () => {
        row.remove();
        updateMonthView(activeTabId);
    };
    row.querySelectorAll('input').forEach(input => {
        input.oninput = () => updateMonthView(activeTabId);
    });
}

function updateMonthView(monthId) {
    if (!monthId || monthId === 'summary') return;
    
    const view = tabContentContainer;
    const monthData = appData[monthId];
    
    // Calcula totais
    const incomeRows = view.querySelectorAll('.income-table tbody tr');
    const expenseRows = view.querySelectorAll('.expense-table tbody tr');
    const incomeItems = Array.from(incomeRows).map(rowToItem);
    const expenseItems = Array.from(expenseRows).map(rowToItem);
    const { totalIncome, totalExpenses } = calculateMonthTotals({ incomes: incomeItems, expenses: expenseItems });
    const finalBalance = totalIncome - totalExpenses;
    
    // Atualiza resumo
    view.querySelector('.total-income').textContent = formatCurrency(totalIncome);
    view.querySelector('.total-expenses').textContent = formatCurrency(totalExpenses);
    const balanceEl = view.querySelector('.final-balance');
    balanceEl.textContent = formatCurrency(finalBalance);
    balanceEl.style.color = finalBalance < 0 ? 'var(--danger-color)' : 'var(--success-color)';

    // Atualiza gráficos
    updateDoughnutChart(monthData.incomeChart, incomeItems);
    updateDoughnutChart(monthData.expenseChart, expenseItems);
    
    // Salva os dados no estado global em tempo real
    saveCurrentTabData();
}

function handleAddMonth() {
    const monthYear = prompt("Digite o mês e ano no formato MM-AAAA (ex: 09-2025):", `${String(new Date().getMonth() + 1).padStart(2, '0')}-${new Date().getFullYear()}`);
    if (monthYear && /^\d{2}-\d{4}$/.test(monthYear)) {
        const [month, year] = monthYear.split('-');
        const monthId = `${year}-${month}`;
        if (appData[monthId]) {
            alert("Este mês já existe!");
            return;
        }
        addMonth(monthId);
    } else if (monthYear) {
        alert("Formato inválido. Por favor, use MM-AAAA.");
    }
}

function addMonth(monthId) {
    appData[monthId] = { incomes: [], expenses: [] };
    renderTabs();
    switchTab(monthId);
}

// --- LÓGICA DE SALVAR/CARREGAR DADOS ---

function saveCurrentTabData() {
    if (!activeTabId || activeTabId === 'summary') return;

    const view = tabContentContainer;
    const incomeRows = view.querySelectorAll('.income-table tbody tr');
    const expenseRows = view.querySelectorAll('.expense-table tbody tr');

    appData[activeTabId] = {
        incomes: Array.from(incomeRows).map(rowToItem),
        expenses: Array.from(expenseRows).map(rowToItem),
        incomeChart: appData[activeTabId].incomeChart, // Preserva a instância do gráfico
        expenseChart: appData[activeTabId].expenseChart,
    };
    saveAppData(); // Salva no Local Storage
}

function saveDataToFile() {
    saveCurrentTabData(); // Garante que os últimos dados estão salvos
    const dataString = JSON.stringify(appData, (key, value) => {
        // Exclui as instâncias dos gráficos ao salvar no arquivo
        if (key === 'incomeChart' || key === 'expenseChart') return undefined;
        return value;
    }, 2);
    const blob = new Blob([dataString], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `planejador-financeiro-${new Date().toISOString().slice(0, 10)}.txt`;
    link.click();
    alert('Dados salvos com sucesso!');
}

function loadDataFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loadedData = JSON.parse(e.target.result);
            appData = loadedData;
            saveAppData();
            renderTabs();
            switchTab('summary'); // Vai para o resumo após carregar
            alert('Dados carregados com sucesso!');
        } catch (error) {
            alert('Erro ao carregar o arquivo.');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function saveAppData() {
    const dataToSave = JSON.parse(JSON.stringify(appData, (key, value) => {
        if (key === 'incomeChart' || key === 'expenseChart') return undefined;
        return value;
    }));
    localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(dataToSave));
}

function loadAppData() {
    const savedData = localStorage.getItem(DATA_STORAGE_KEY);
    if (savedData) {
        appData = JSON.parse(savedData);
    }
}

// --- FUNÇÕES AUXILIARES ---

function formatCurrency(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
function rowToItem(row) {
    return {
        description: row.querySelector('.description-input').value || 'Sem descrição',
        value: parseFloat(row.querySelector('.value-input').value) || 0,
    };
}
function calculateMonthTotals(monthData) {
    const totalIncome = (monthData.incomes || []).reduce((sum, item) => sum + item.value, 0);
    const totalExpenses = (monthData.expenses || []).reduce((sum, item) => sum + item.value, 0);
    return { totalIncome, totalExpenses };
}

// --- FUNÇÕES DE GRÁFICOS (CHART.JS) ---

function createDoughnutChart(canvas) {
    return new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: { labels: [], datasets: [{ data: [], backgroundColor: ['#00aaff', '#ff4d4d', '#4dff4d', '#ffc107', '#6f42c1', '#fd7e14', '#20c997'], hoverOffset: 4 }] },
        options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#FFFFFF' } } } }
    });
}

function updateDoughnutChart(chart, items) {
    const filteredItems = items.filter(item => item.value > 0);
    chart.data.labels = filteredItems.map(d => d.description);
    chart.data.datasets[0].data = filteredItems.map(d => d.value);
    chart.update();
}

function createLineChart(canvas, labels, incomeData, expenseData) {
    new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Receitas',
                    data: incomeData,
                    borderColor: 'var(--success-color)',
                    backgroundColor: 'rgba(77, 255, 77, 0.1)',
                    fill: true,
                    tension: 0.1
                },
                {
                    label: 'Despesas',
                    data: expenseData,
                    borderColor: 'var(--danger-color)',
                    backgroundColor: 'rgba(255, 77, 77, 0.1)',
                    fill: true,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { ticks: { color: '#FFFFFF' } },
                x: { ticks: { color: '#FFFFFF' } }
            },
            plugins: {
                legend: { labels: { color: '#FFFFFF' } }
            }
        }
    });
}
</script>

</body>
</html>
